version: "3.8"

services:

  # Reverse proxy
  traefik:
    image: "traefik:v2.9"
    restart: unless-stopped

    # Static configuration of Traefik
    environment:
      # General configuration
      - TRAEFIK_LOG_LEVEL=ERROR
      - TRAEFIK_API_DASHBOARD=true
      - TRAEFIK_PROVIDERS_DOCKER=true
      - TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT=true
      - TRAEFIK_PROVIDERS_DOCKER_CONSTRAINTS="Label(`pontos.expose`, `true`)"

      # Entrypoints
      - TRAEFIK_ENTRYPOINTS_web_ADDRESS=:80
      - TRAEFIK_ENTRYPOINTS_traefik-dashboard_ADDRESS=:8080
      - TRAEFIK_ENTRYPOINTS_emqx-dashboard_ADDRESS=:8081

    # Dynamic configuration for exposing Traefik's dashboard an api on a separate endpoints
    labels:
      - "pontos.expose=true"
      - "traefik.http.routers.traefik-dashboard.rule=(PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.traefik-dashboard.entryPoints=traefik-dashboard"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
    ports:
      - "${PONTOS_HUB_EXTERNAL_HTTP_PORT:-80}:80"
      - "${PONTOS_HUB_EXTERNAL_TRAEFIK_DASHBOARD_PORT:-0}:8080"
      - "${PONTOS_HUB_EXTERNAL_EMQX_DASHBOARD_PORT:-0}:8081"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"

  # MQTT broker
  emqx:
    image: emqx/emqx:4.4.14
    restart: unless-stopped
    environment:
      - EMQX_NAME=pontos-hub
      - EMQX_HOST=127.0.0.1
      - EMQX_ALLOW_ANONYMOUS=false
      - EMQX_ACL_NOMATCH=allow
    labels:
      - "pontos.expose=true"
      - "traefik.http.routers.emqx-ws.rule=Host(`${PONTOS_HUB_HOST}`) && PathPrefix(`/mqtt`)"
      - "traefik.http.routers.emqx-ws.entryPoints=web"
      - "traefik.http.routers.emqx-ws.service=emqx-ws-service"
      - "traefik.http.services.emqx-ws-service.loadbalancer.server.port=8083"
      - "traefik.tcp.routers.emqx-dashboard.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.emqx-dashboard.entryPoints=emqx-dashboard"
      - "traefik.tcp.routers.emqx-dashboard.service=emqx-dashboard-service"
      - "traefik.tcp.services.emqx-dashboard-service.loadbalancer.server.port=18083"
